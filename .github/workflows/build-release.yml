name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v1.0.0 è¿™æ ·çš„æ ‡ç­¾æ—¶è§¦å‘

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          # Windows x64 - åŸç”Ÿæ„å»º
          - os: windows-latest
            output: ClipboardBridge.exe
            archive: ClipboardBridge-windows-amd64.zip
            build_flags: "-ldflags=-H windowsgui"
          
          # Linux x64 - åŸç”Ÿæ„å»º
          - os: ubuntu-latest
            output: clipboard-bridge
            archive: ClipboardBridge-linux-amd64.tar.gz
            build_flags: ""
          
          # macOS Intel - åŸç”Ÿæ„å»º
          - os: macos-13  # Intel runner
            output: clipboard-bridge
            archive: ClipboardBridge-macos-amd64.tar.gz
            build_flags: ""
          
          # macOS Apple Silicon - åŸç”Ÿæ„å»º
          - os: macos-latest  # ARM64 runner
            output: clipboard-bridge
            archive: ClipboardBridge-macos-arm64.tar.gz
            build_flags: ""
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.20'
    
    - name: Install MinGW (Windows only)
      if: runner.os == 'Windows'
      run: choco install mingw -y
    
    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y xclip xsel
    
    - name: Install Go dependencies
      run: go mod download
    
    - name: Build
      run: |
        go build ${{ matrix.build_flags }} -o ${{ matrix.output }}
    
    - name: Create config example
      run: |
        echo '{"port":5678,"token":"","auto_start":true,"auto_firewall":true,"log_level":"info"}' > config.example.json
    
    - name: Create ZIP archive (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        Compress-Archive -Path ${{ matrix.output }},config.example.json -DestinationPath ${{ matrix.archive }}
    
    - name: Create TAR.GZ archive (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        tar -czf ${{ matrix.archive }} ${{ matrix.output }} config.example.json
    
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.archive }}
        path: ${{ matrix.archive }}
  
  release:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: artifacts
    
    - name: Get version
      id: version
      run: |
        echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/**/*
        body: |
          ## ğŸ“¦ Clipboard Bridge ${{ steps.version.outputs.VERSION }}
          
          ### ğŸ¯ æ”¯æŒçš„å¹³å°
          
          | å¹³å° | æ¶æ„ | æ–‡ä»¶ |
          |------|------|------|
          | Windows | x64 | `ClipboardBridge-windows-amd64.zip` |
          | Linux | x64 | `ClipboardBridge-linux-amd64.tar.gz` |
          | macOS | Intel | `ClipboardBridge-macos-amd64.tar.gz` |
          | macOS | Apple Silicon (M1/M2) | `ClipboardBridge-macos-arm64.tar.gz` |
          
          ### ğŸ“¥ ä¸‹è½½è¯´æ˜
          
          **Windows:**
          1. ä¸‹è½½ `ClipboardBridge-windows-amd64.zip`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. åŒå‡»è¿è¡Œ `ClipboardBridge.exe`
          
          **Linux / macOS:**
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„ `.tar.gz` æ–‡ä»¶
          2. è§£å‹: `tar -xzf ClipboardBridge-*.tar.gz`
          3. æ·»åŠ æ‰§è¡Œæƒé™: `chmod +x clipboard-bridge`
          4. è¿è¡Œ: `./clipboard-bridge`
          
          ### ğŸ“ é…ç½®æ–‡ä»¶
          
          é¦–æ¬¡è¿è¡Œä¼šç”Ÿæˆ `config.json`ï¼Œå¯æ ¹æ®éœ€è¦ä¿®æ”¹ï¼š
          - `port`: æœåŠ¡ç«¯å£ï¼ˆé»˜è®¤ 5678ï¼‰
          - `token`: API è®¿é—®ä»¤ç‰Œ
          - `auto_start`: å¼€æœºè‡ªå¯ï¼ˆWindows æ”¯æŒè‡ªåŠ¨é…ç½®ï¼‰
          - `log_level`: æ—¥å¿—çº§åˆ«ï¼ˆdebug/info/errorï¼‰
          
          ### ğŸ”§ å¹³å°å·®å¼‚è¯´æ˜
          
          - **Windows**: æ”¯æŒç³»ç»Ÿçº§å‰ªè´´æ¿ç›‘å¬ã€è‡ªåŠ¨å¼€æœºè‡ªå¯ã€é˜²ç«å¢™é…ç½®
          - **Linux/macOS**: ä½¿ç”¨è½®è¯¢æ–¹å¼ç›‘å¬å‰ªè´´æ¿ï¼Œå¼€æœºè‡ªå¯å’Œé˜²ç«å¢™éœ€æ‰‹åŠ¨é…ç½®
          
          ### æ›´æ–°å†…å®¹
          
          è¯·æŸ¥çœ‹æäº¤è®°å½•äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

