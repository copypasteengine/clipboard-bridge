name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v1.0.0 è¿™æ ·çš„æ ‡ç­¾æ—¶è§¦å‘

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false  # ä¸è¦å› ä¸ºä¸€ä¸ªå¤±è´¥å°±å–æ¶ˆå…¶ä»–ä»»åŠ¡
      matrix:
        include:
          # Windows x64 - åŸç”Ÿæ„å»º
          - os: windows-latest
            output: clipboard-bridge.exe
            archive: clipboard-bridge-windows-amd64.zip
          
          # Linux x64 - åŸç”Ÿæ„å»º
          - os: ubuntu-latest
            output: clipboard-bridge
            archive: clipboard-bridge-linux-amd64.tar.gz
          
          # macOS (é€šç”¨) - åŸç”Ÿæ„å»º
          # æ³¨æ„: GitHub å…è´¹ runner åªæä¾› ARM64 (Apple Silicon)
          - os: macos-latest
            output: clipboard-bridge
            archive: clipboard-bridge-macos-arm64.tar.gz
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.20'
    
    - name: Setup MinGW (Windows)
      if: runner.os == 'Windows'
      run: |
        choco install mingw -y --force
        Write-Host "MinGW installed"
      shell: powershell
    
    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y xclip xsel libgtk-3-dev libayatana-appindicator3-dev
    
    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        echo "macOS dependencies check..."
        # macOS è‡ªå¸¦å‰ªè´´æ¿æ”¯æŒï¼Œä¸éœ€è¦é¢å¤–ä¾èµ–
    
    - name: Install Go dependencies
      run: |
        go mod download
        go mod verify
    
    - name: Build (Windows)
      if: runner.os == 'Windows'
      env:
        CGO_ENABLED: "1"
      run: |
        # æŸ¥æ‰¾å¹¶æ·»åŠ  MinGW åˆ° PATH
        $mingwPath = "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin"
        if (Test-Path $mingwPath) {
          $env:PATH = "$mingwPath;$env:PATH"
          Write-Host "Added MinGW to PATH: $mingwPath"
        }
        
        Write-Host "Building for Windows..."
        go version
        Write-Host "CGO_ENABLED: $env:CGO_ENABLED"
        
        # éªŒè¯ GCC æ˜¯å¦å¯ç”¨
        try {
          gcc --version
          Write-Host "GCC is available"
        } catch {
          Write-Host "WARNING: GCC not found in PATH"
          Write-Host "Current PATH: $env:PATH"
        }
        
        # æ„å»º - Windows éœ€è¦éšè—çª—å£æ ‡å¿—
        Write-Host "Building Windows executable..."
        go build -v -ldflags="-H windowsgui" -o ${{ matrix.output }}
        
        if ($LASTEXITCODE -ne 0) { 
          Write-Host "Build failed with exit code $LASTEXITCODE"
          exit $LASTEXITCODE 
        }
        
        Write-Host "Build completed successfully"
        Get-Item ${{ matrix.output }}
      shell: powershell
    
    - name: Build (Unix)
      if: runner.os != 'Windows'
      env:
        CGO_ENABLED: 1
      run: |
        echo "Building for ${{ runner.os }}..."
        go version
        go env
        echo "CGO_ENABLED=$CGO_ENABLED"
        go build -v -o ${{ matrix.output }} 2>&1 | tee build.log || (cat build.log && exit 1)
        echo "Build completed successfully"
        ls -lh ${{ matrix.output }}
    
    - name: Create config example
      run: |
        echo '{"port":5678,"token":"","auto_start":true,"auto_firewall":true,"log_level":"info"}' > config.example.json
    
    - name: Create ZIP archive (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        Compress-Archive -Path ${{ matrix.output }},config.example.json -DestinationPath ${{ matrix.archive }}
    
    - name: Create TAR.GZ archive (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        tar -czf ${{ matrix.archive }} ${{ matrix.output }} config.example.json
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.archive }}
        path: ${{ matrix.archive }}
  
  release:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        pattern: "*"
        merge-multiple: true
    
    - name: Get version
      id: version
      run: |
        echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/*
        body: |
          ## ğŸ“¦ Clipboard Bridge ${{ steps.version.outputs.VERSION }}
          
          [ä¸­æ–‡è¯´æ˜](https://github.com/copypasteengine/clipboard-bridge/blob/main/README.zh-CN.md) | [Documentation](https://github.com/copypasteengine/clipboard-bridge#readme)
          
          Cross-device clipboard sync solution with desktop service and native Android app.
          
          ### ğŸ–¥ï¸ Desktop Versions
          
          | Platform | Architecture | File |
          |----------|--------------|------|
          | Windows | x64 | `clipboard-bridge-windows-amd64.zip` |
          | Linux | x64 | `clipboard-bridge-linux-amd64.tar.gz` |
          | macOS | Apple Silicon | `clipboard-bridge-macos-arm64.tar.gz` |
          
          ### ğŸ“± Mobile Versions
          
          | Platform | File | Note |
          |----------|------|------|
          | Android | `clipboard-bridge-android-*-debug.apk` | Ready to install |
          | iOS | - | Use Shortcuts (see docs) |
          
          > **Note**: 
          > - macOS Intel version requires local build
          > - Android Release APK requires signing configuration
          
          ### ğŸ“¥ Installation
          
          **ğŸ–¥ï¸ Desktop:**
          
          **Windows:**
          1. Download `clipboard-bridge-windows-amd64.zip`
          2. Extract and run `clipboard-bridge.exe`
          3. Service starts automatically on port 5678
          
          **Linux / macOS:**
          ```bash
          tar -xzf clipboard-bridge-*.tar.gz
          chmod +x clipboard-bridge
          ./clipboard-bridge
          ```
          
          **ğŸ“± Android:**
          1. Download `clipboard-bridge-android-*-debug.apk`
          2. Install on Android device (enable "Install from unknown sources")
          3. Open app and configure server address
          4. Start syncing!
          
          ### âš™ï¸ Configuration
          
          First run generates `config.json`:
          - `port`: Service port (default 5678)
          - `token`: API access token (optional)
          - `auto_start`: Auto-start on boot (Windows auto-config)
          - `log_level`: Log level (debug/info/error)
          
          ### ğŸŒ Multi-Language Support
          
          - Interface: English, ç®€ä½“ä¸­æ–‡, æ—¥æœ¬èª
          - Auto-detect system language
          
          ### ğŸ”§ Platform Features
          
          - **Windows**: System-level clipboard monitoring, auto-start, firewall auto-config
          - **Linux/macOS**: Polling-based monitoring, manual startup configuration
          
          ### ğŸ“š Documentation
          
          - [Quick Start Guide](https://github.com/copypasteengine/clipboard-bridge/blob/main/QUICKSTART.md)
          - [Android App Manual](https://github.com/copypasteengine/clipboard-bridge/blob/main/android-app/README.md)
          - [Architecture](https://github.com/copypasteengine/clipboard-bridge/blob/main/ARCHITECTURE.md)
          
          ### ğŸ“ Changelog
          
          See commit history for detailed changes.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

