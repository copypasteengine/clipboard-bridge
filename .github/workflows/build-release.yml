name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v1.0.0 è¿™æ ·çš„æ ‡ç­¾æ—¶è§¦å‘

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false  # ä¸è¦å› ä¸ºä¸€ä¸ªå¤±è´¥å°±å–æ¶ˆå…¶ä»–ä»»åŠ¡
      matrix:
        include:
          # Windows x64 - åŸç”Ÿæ„å»º
          - os: windows-latest
            output: ClipboardBridge.exe
            archive: ClipboardBridge-windows-amd64.zip
            build_flags: "-ldflags=-H windowsgui"
          
          # Linux x64 - åŸç”Ÿæ„å»º
          - os: ubuntu-latest
            output: clipboard-bridge
            archive: ClipboardBridge-linux-amd64.tar.gz
            build_flags: ""
          
          # macOS (é€šç”¨) - åŸç”Ÿæ„å»º
          # æ³¨æ„: GitHub å…è´¹ runner åªæä¾› ARM64 (Apple Silicon)
          - os: macos-latest
            output: clipboard-bridge
            archive: ClipboardBridge-macos-arm64.tar.gz
            build_flags: ""
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.20'
    
    - name: Setup MinGW (Windows)
      if: runner.os == 'Windows'
      run: |
        choco install mingw -y --force
        Write-Host "MinGW installed"
      shell: powershell
    
    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y xclip xsel libgtk-3-dev libayatana-appindicator3-dev
    
    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        echo "macOS dependencies check..."
        # macOS è‡ªå¸¦å‰ªè´´æ¿æ”¯æŒï¼Œä¸éœ€è¦é¢å¤–ä¾èµ–
    
    - name: Install Go dependencies
      run: |
        go mod download
        go mod verify
    
    - name: Build (Windows)
      if: runner.os == 'Windows'
      env:
        CGO_ENABLED: "1"
      run: |
        # æŸ¥æ‰¾å¹¶æ·»åŠ  MinGW åˆ° PATH
        $mingwPath = "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin"
        if (Test-Path $mingwPath) {
          $env:PATH = "$mingwPath;$env:PATH"
          Write-Host "Added MinGW to PATH: $mingwPath"
        }
        
        Write-Host "Building for Windows..."
        go version
        Write-Host "CGO_ENABLED: $env:CGO_ENABLED"
        
        # éªŒè¯ GCC æ˜¯å¦å¯ç”¨
        try {
          gcc --version
          Write-Host "GCC is available"
        } catch {
          Write-Host "WARNING: GCC not found in PATH"
          Write-Host "Current PATH: $env:PATH"
        }
        
        # æ„å»º
        go build -v ${{ matrix.build_flags }} -o ${{ matrix.output }}
        if ($LASTEXITCODE -ne 0) { 
          Write-Host "Build failed with exit code $LASTEXITCODE"
          exit $LASTEXITCODE 
        }
        
        Write-Host "Build completed successfully"
        Get-Item ${{ matrix.output }}
      shell: powershell
    
    - name: Build (Unix)
      if: runner.os != 'Windows'
      env:
        CGO_ENABLED: 1
      run: |
        echo "Building for ${{ runner.os }}..."
        go version
        go env
        echo "CGO_ENABLED=$CGO_ENABLED"
        go build -v ${{ matrix.build_flags }} -o ${{ matrix.output }} 2>&1 | tee build.log || (cat build.log && exit 1)
        echo "Build completed successfully"
        ls -lh ${{ matrix.output }}
    
    - name: Create config example
      run: |
        echo '{"port":5678,"token":"","auto_start":true,"auto_firewall":true,"log_level":"info"}' > config.example.json
    
    - name: Create ZIP archive (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        Compress-Archive -Path ${{ matrix.output }},config.example.json -DestinationPath ${{ matrix.archive }}
    
    - name: Create TAR.GZ archive (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        tar -czf ${{ matrix.archive }} ${{ matrix.output }} config.example.json
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.archive }}
        path: ${{ matrix.archive }}
  
  release:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        pattern: "*"
        merge-multiple: true
    
    - name: Get version
      id: version
      run: |
        echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/*
        body: |
          ## ğŸ“¦ Clipboard Bridge ${{ steps.version.outputs.VERSION }}
          
          ### ğŸ¯ æ”¯æŒçš„å¹³å°
          
          | å¹³å° | æ¶æ„ | æ–‡ä»¶ |
          |------|------|------|
          | Windows | x64 | `ClipboardBridge-windows-amd64.zip` |
          | Linux | x64 | `ClipboardBridge-linux-amd64.tar.gz` |
          | macOS | Apple Silicon (M1/M2/M3) | `ClipboardBridge-macos-arm64.tar.gz` |
          
          > **æ³¨æ„**: macOS Intel ç‰ˆæœ¬éœ€è¦æœ¬åœ°ç¼–è¯‘æˆ–ä½¿ç”¨ä»˜è´¹ GitHub runnerã€‚
          
          ### ğŸ“¥ ä¸‹è½½è¯´æ˜
          
          **Windows:**
          1. ä¸‹è½½ `ClipboardBridge-windows-amd64.zip`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. åŒå‡»è¿è¡Œ `ClipboardBridge.exe`
          
          **Linux / macOS:**
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„ `.tar.gz` æ–‡ä»¶
          2. è§£å‹: `tar -xzf ClipboardBridge-*.tar.gz`
          3. æ·»åŠ æ‰§è¡Œæƒé™: `chmod +x clipboard-bridge`
          4. è¿è¡Œ: `./clipboard-bridge`
          
          ### ğŸ“ é…ç½®æ–‡ä»¶
          
          é¦–æ¬¡è¿è¡Œä¼šç”Ÿæˆ `config.json`ï¼Œå¯æ ¹æ®éœ€è¦ä¿®æ”¹ï¼š
          - `port`: æœåŠ¡ç«¯å£ï¼ˆé»˜è®¤ 5678ï¼‰
          - `token`: API è®¿é—®ä»¤ç‰Œ
          - `auto_start`: å¼€æœºè‡ªå¯ï¼ˆWindows æ”¯æŒè‡ªåŠ¨é…ç½®ï¼‰
          - `log_level`: æ—¥å¿—çº§åˆ«ï¼ˆdebug/info/errorï¼‰
          
          ### ğŸ”§ å¹³å°å·®å¼‚è¯´æ˜
          
          - **Windows**: æ”¯æŒç³»ç»Ÿçº§å‰ªè´´æ¿ç›‘å¬ã€è‡ªåŠ¨å¼€æœºè‡ªå¯ã€é˜²ç«å¢™é…ç½®
          - **Linux/macOS**: ä½¿ç”¨è½®è¯¢æ–¹å¼ç›‘å¬å‰ªè´´æ¿ï¼Œå¼€æœºè‡ªå¯å’Œé˜²ç«å¢™éœ€æ‰‹åŠ¨é…ç½®
          
          ### æ›´æ–°å†…å®¹
          
          è¯·æŸ¥çœ‹æäº¤è®°å½•äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

